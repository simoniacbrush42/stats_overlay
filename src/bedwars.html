<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Stats Overlay</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="bedwars.css">
</head>

<body>
    <div id="sidebar">
        <div class="toggle-btn" onclick="show()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <ul>
            <li>
                <form action="bedwars.html">
                    <button>Bedwars</button>
                </form>
            </li>
            <li>
                <form action="bridge.html">
                    <button>Bridge</button>
                </form>
            </li>
            <li>
                <form action="search.html">
                    <button>Search</button>
                </form>
            </li>
            <li>
                <form action="settings.html">
                    <button>Settings</button>
                </form>

            </li>
        </ul>
    </div>
    <div class="stats">
        <table>
            <thead class="titles">
                <th style="padding-right: 130px;">Player</th>
                <th>WS</th>
                <th>FKDR</th>
                <th style="padding-right: 30px; padding-left: 30px;">Finals</th>
                <th>Index</th>
                <th>BBL</th>
                <th>WLR</th>
                <th style="padding-right: 0;">Joined Time</th>
            </thead>
            <tbody class="table_body" id="tbody">
                
            </tbody>
        </table>

    </div>
    <script>
        function show() {
            document.getElementById("sidebar").classList.toggle('active');
        }
    </script>
    <script>
        function to_gui(arr) {

        }
    </script>
    <script>
        
        console.log("running")
        const electron = require('electron');
        const readLastLines = require('read-last-lines');
        var fs = require('fs');
        const path = require('path');
        /*
        const log_timestamp = require('log-timestamp');

        const buttonPressesLogFile = '../../../../../../Users/simon/.lunarclient/offline/1.8/logs/latest.log';

        console.log(`Watching for file changes on ${buttonPressesLogFile}`);

        fs.watchFile(buttonPressesLogFile, { interval: 1}, (curr, prev) => {
          console.log(`${buttonPressesLogFile} file Changed`);
          readLastLines.read('../../../../../../Users/simon/.lunarclient/offline/1.8/logs/latest.log', 1)
                .then((lines) => {
                    console.log("bo")
                    line_parts = lines.split(' ')
                    if (line_parts[4] == "ONLINE:") {
                        stats = []
                        names = line_parts.slice(5);
                        //console.log(names)
                        const table_body = document.querySelector('tbody');
                        //console.log("poo");
                        table_body.innerHTML = "";
                        for (ind in names) {
                            let name = names[ind].replace(",", "");
                            getData(name);
                            //console.log(arr)
                            //stats.push(arr)
                        }
                        //console.log(stats)

                        //FINALLYt
                    }
                })
        });
        */
        names = ["lowof", "deansiie", "wemmbu", "dragondoodler222"]
        for (ind in names) {
            getData(names[ind]);
            //console.log(arr)
            //stats.push(arr)
        }       

        /*
        var options = {
            logFile: '../../../../../../Users/simon/.lunarclient/offline/1.8/logs/latest.log',
            endOfLineChar: require('os').EOL
        };
        // Obtain the initial size of the log file before we begin watching it.
        var fileSize = fs.statSync(options.logFile).size;
        fs.watchFile(options.logFile, function (current, previous) {
            // Check if file modified time is less than last time.
            // If so, nothing changed so don't bother parsing.
            if (current.mtime <= previous.mtime) {
                return;
            }

            // We're only going to read the portion of the file that
            // we have not read so far. Obtain new file size.
            var newFileSize = fs.statSync(options.logFile).size;
            // Calculate size difference.
            var sizeDiff = newFileSize - fileSize;
            // If less than zero then Hearthstone truncated its log file
            // since we last read it in order to save space.
            // Set fileSize to zero and set the size difference to the current
            // size of the file.
            if (sizeDiff < 0) {
                fileSize = 0;
                sizeDiff = newFileSize;
            }
            // Create a buffer to hold only the data we intend to read.
            var buffer = new Buffer(sizeDiff);
            // Obtain reference to the file's descriptor.
            var fileDescriptor = fs.openSync(options.logFile, 'r');
            // Synchronously read from the file starting from where we read
            // to last time and store data in our buffer.
            fs.readSync(fileDescriptor, buffer, 0, sizeDiff, fileSize);
            fs.closeSync(fileDescriptor); // close the file
            // Set old file size to the new size for next read.
            fileSize = newFileSize;

            // Parse the line(s) in the buffer.
            parseBuffer(buffer);
        });

        function stop() {
            fs.unwatchFile(options.logFile);
        };

        var stats = [];

        function parseBuffer(buffer) {
            // Iterate over each line in the buffer.
            buffer.toString().split(options.endOfLineChar).forEach(function (line) {
                // Do stuff with the line :)
                console.log('change')
                line_parts = line.split(' ')
                if (line_parts[4] == "ONLINE:") {
                    stats = []
                    names = line_parts.slice(5);
                    //console.log(names)
                    const table_body = document.querySelector('tbody');
                    //console.log("poo");
                    table_body.innerHTML = "";
                    for (ind in names) {
                        let name = names[ind].replace(",", "");
                        getData(name);
                        //console.log(arr)
                        //stats.push(arr)
                    }
                    //console.log(stats)

                    //FINALLYt
                }
            });
        }
        /*
        names = ["lowof,", "bunnyhead,", "dragondoodler222,", "wemmbu,", "tqrtle,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,", "lowof,"]
        */
        //table_body.innerHTML = "";
        /*
        for (ind in names) {
            let name = names[ind].replace(",", "");
            getData(name);
            //console.log(arr)
            //stats.push(arr)
        }
        */
        function getData(name) {
            //console.log(name)
            let uid = ''
            fetch('https://api.mojang.com/users/profiles/minecraft/' + name + '?at=')
                .then(result => {
                    //console.log(result.json())
                    return result.json()
                })

                .then(({
                    id
                }) => {
                    //console.log(id)
                    // Log the player's username
                    uid = id;
                    fetch("https://api.hypixel.net/player?key=3aadacc6-2c7d-485e-8b8d-801109c40c46&uuid=" +
                            uid)
                        .then(result => result.json())
                        .then(({
                            player
                        }) => {
                            stats = []
                            //console.log(player)
                            // Log the player's username
                            let name = player.displayname
                            let last_login = player.lastLogin
                            let star = player.achievements.bedwars_level
                            let ws = player.stats.Bedwars.winstreak
                            let finals = player.stats.Bedwars.final_kills_bedwars
                            let final_deaths = player.stats.Bedwars.final_deaths_bedwars
                            let fkdr;
                            if (!final_deaths) {
                                fkdr = finals
                            } else {
                                fkdr = (finals / final_deaths).toFixed(2)
                            }
                            let beds = player.stats.Bedwars.beds_broken_bedwars
                            let beds_lost = player.stats.Bedwars.beds_lost_bedwars
                            let bbl;
                            if (!beds_lost) {
                                bbl = beds
                            } else {
                                bbl = (beds / beds_lost).toFixed(2)
                            }
                            let wins = player.stats.Bedwars.wins_bedwars
                            let losses = player.stats.Bedwars.losses_bedwars
                            let wlr;
                            if (!losses) {
                                wlr = wins
                            } else {
                                wlr = (wins / losses).toFixed(2)
                            }
                            let index = ((fkdr ** 2) * star).toFixed(0)
                            time = new Date(Date.now());
                            //console.log(time)
                            var login = new Date(last_login);
                            //console.log(login)
                            const diffInMins = Math.floor(Math.abs(time - login) / 60) % 60;
                            //console.log(diffInMins)
                            stats.push(name, ws, fkdr, finals, index, bbl, wlr,
                                diffInMins
                            )
                            const table_body = document.querySelector('tbody');
                            let rank;
                            let rank_color;
                            if (player.rank){
                                rank = player.rank;
                                if (rank == "YOUTUBER"){
                                    rank = "[YOUTUBE]"
                                    rank_color = "#FF5555"

                                }else if (rank == "ADMIN"){
                                    rank = "[ADMIN]"
                                }
                            } else {
                                if (player.monthlyPackageRank){
                                    rank = player.monthlyPackageRank
                                    if (player.monthlyPackageRank == "SUPERSTAR"){
                                        rank = "[MVP++]"
                                        rank_color = player.monthlyRankColor
                                        if (rank_color == "GOLD"){
                                            rank_color = "rgb(255,170,0)"
                                        } else {
                                            rank_color = "rgb(85,255,255)"
                                        }
                                    } else{
                                        new_pckg = player.newPackageRank
                                        if (new_pckg){
                                            //console.log("bo")
                                            //rank = new_pckg
                                            console.log(rank)
                                            if (rank == "MVP_PLUS"){
                                                rank = "[MVP+]"
                                                rank_color = "rgb(85,255,255)"
                                            } else if (rank == "MVP"){
                                                rank = "[MVP]"
                                                rank_color = "rgb(85,255,255)"
                                            } else if (rank == "VIP_PLUS"){
                                                rank = "[VIP+]"
                                                rank_color = "rgb(85,255,85)"
                                            } else if (rank == "VIP"){
                                                console.log("vip")
                                                rank = "[VIP]"
                                                rank_color = "rgb(85,255,85)"
                                            }
                                        } else{
                                            rank = ""
                                        }
                                        
                                    }
                                } else if (player.newPackageRank){
                                        new_pckg = player.newPackageRank
                                        if (new_pckg){
                                            //console.log("new")
                                            rank = new_pckg
                                            if (rank == "MVP_PLUS"){
                                                //console.log('smell')
                                                rank = "[MVP+]"
                                                rank_color = "rgb(85,255,255)"
                                            } else if (rank == "MVP"){
                                                rank = "[MVP]"
                                                rank_color = "rgb(85,255,255)"
                                            } else if (rank == "VIP_PLUS"){
                                                rank = "[VIP+]"
                                                rank_color = "rgb(85,255,85)"
                                            } else if (rank == "VIP"){
                                                rank = "[VIP]"
                                                rank_color = "rgb(85,255,85)"
                                            }
                                        } else{
                                            rank = ""
                                        }
                                } else{
                                    //console.log('test')
                                    new_pckg = player.packageRank
                                    //console.log(new_pckg)
                                    if (new_pckg){
                                        rank = new_pckg
                                        console.log(rank)
                                        if (rank == "MVP_PLUS"){
                                            //console.log('smell')
                                            rank = "[MVP+]"
                                        } else if (rank == "MVP"){
                                            rank = "[MVP]"
                                        } else if (rank == "VIP_PLUS"){
                                            rank = "[VIP+]"
                                        } else if (rank == "VIP"){
                                            console.log("vip")
                                            rank = "[VIP]"
                                        }
                                    } else{
                                        rank = ""
                                    }
                                        
                                }
                            }
                            
                            let plusColor;

                            if (player.rankPlusColor){
                                plusColor = player.rankPlusColor
                            } else{
                                plusColor = ""
                            }
                            ign = document.createElement('li')
                            let plus;
                            let p1;
                            let p2;
                            let plusFound = false;
                            console.log(rank)
                             if (rank != "NONE"){
                                name = rank + " " + name
                            } else {
                                rank_color = "#AAAAAA"
                            }
                            if (rank == "[YOUTUBE]"){
                                console.log("youtuber")
                                p1 = name.substring(0,1)
                                plus = name.substring(1,8)
                                p2 = name.substring(8)  
                            } else {
                                console.log("normal")
                                for (var i = 0; i < name.length; i++){
                                    if (name[i] == "+"){
                                        plusFound = true;
                                        p1 = name.substring(0,i)
                                        if (name[i+1] == "+"){
                                            plus = name.substring(i,i+2)
                                            p2 = name.substring((i+2));
                                        
                                        } else {
                                            plus = name.substring(i,i+1)
                                            p2 = name.substring(i+1);
                                        }
                                        {break;}
                                    }
                                }
                            }
                            if (!plusFound && rank != "[YOUTUBE]"){
                                p1 = name.substring(0,5)
                                p2 = name.substring(5)
                            }
                           
                            let span = document.createElement("span");

                            span.textContent = plus
                            if (rank == "[YOUTUBE]"){
                                plusc = "#E0E0E0"
                            } else {
                                plusc = plus_to_color(plusColor)
                            }
                            let im_span = document.createElement("span")
                            let im = document.createElement("img")
                            im.src = "https://crafatar.com/avatars/" + uid +
                                "?size=15&default=MHF_Steve&overlay"
                            im_span.appendChild(im)
                            console.log(plusc, name)
                            span.style.color = plusc
                            ign.appendChild(im_span)
                            ign.appendChild(document.createTextNode(p1))
                            ign.appendChild(span)
                            ign.appendChild(document.createTextNode(p2))


                            const tr = document.createElement("tr");
                            tr.style.paddingBottom = "100px"
                            tr.appendChild(ign)
                            /*
                            for (i in stats) {
                                //console.log(i)
                                //console.log(stats[i])
                                const data = document.createElement("td");

                                if (i == 0) {
                                    const im = document.createElement("img")
                                    const par = document.createElement("p")
                                    parts = stats[i].split(" ")
                                    im.src = parts[0]
                                    im.style.paddingRight = "5px";
                                    data.appendChild(im)
                                    par.innerHTML = "  " + parts[1] + " " + parts[2];
                                    data.style.paddingRight = "40px"
                                    data.appendChild(par)
                                    data.style.display = "flex";
                                } else if (i == 4) {
                                    data.style.paddingRight = "30px"
                                    data.style.paddingLeft = "30px"
                                } else if (i == 8) {
                                    data.style.paddingRight = "0px"
                                }
                                if (i != 0) {
                                    data.innerHTML = stats[i]
                                }
                                tr.appendChild(data)
                            }
                            */
                            table_body.appendChild(tr)



                        });
                })
                .catch((error) => {
                    //console.log('err')
                    /*stats.push(name, 'NICKED', 'NICKED', 'NICKED', 'NICKED', "NICKED",
                        'NICKED', 'NICKED', 'NICKED'
                    )
                    */
                })
                .finally(() => {
                    //console.log(stats)
                    return
                });





        }
    </script>
    <script type="text/javascript" src="plusColor.js"></script>





</body>

</html>