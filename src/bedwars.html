<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Stats Overlay</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="bedwars.css">
</head>

<body>
    <div id="sidebar">
        <div class="toggle-btn" onclick="show()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <ul>
            <li>
                <form action="bedwars.html">
                    <button>Bedwars</button>
                </form>
            </li>
            <li>
                <form action="bridge.html">
                    <button>Bridge</button>
                </form>
            </li>
            <li>
                <form action="search.html">
                    <button>Search</button>
                </form>
            </li>
            <li>
                <form action="settings.html">
                    <button>Settings</button>
                </form>

            </li>
        </ul>
    </div>
    <div class="stats">
        <table>
            <thead class="titles">
                <th style="padding-right: 60px;">Player</th>
                <th>WS</th>
                <th>FKDR</th>
                <th style="padding-right: 30px; padding-left: 30px;">Finals</th>
                <th>Index</th>
                <th>BBL</th>
                <th>WLR</th>
                <th style="padding-right: 0;">Joined Time</th>
            </thead>
            <tbody class="table_body" id="tbody">
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/e70a46aa830a46f387613dd18ea9867e?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [11] Weev1c</p>
                    </td>
                    <td>11</td>
                    <td>0.12</td>
                    <td>38</td>
                    <td style="padding-right: 30px; padding-left: 30px;">0</td>
                    <td>0.07</td>
                    <td>0.02</td>
                    <td>2</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/fd71341062104174b55ed40c0dd1344f?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [15] DaGiraffe4YT</p>
                    </td>
                    <td>15</td>
                    <td>0.53</td>
                    <td>115</td>
                    <td style="padding-right: 30px; padding-left: 30px;">4</td>
                    <td>0.32</td>
                    <td>0.12</td>
                    <td>41</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/c0cfa9b000c94a56a8cbece51eb29bc9?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [42] MushCrush12</p>
                    </td>
                    <td>42</td>
                    <td>0.53</td>
                    <td>506</td>
                    <td style="padding-right: 30px; padding-left: 30px;">12</td>
                    <td>0.55</td>
                    <td>0.09</td>
                    <td>48</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/6b0cfe60caa845ef9c3c33eaaf49d5d6?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [60] Tusseluss</p>
                    </td>
                    <td>60</td>
                    <td>0.47</td>
                    <td>556</td>
                    <td style="padding-right: 30px; padding-left: 30px;">13</td>
                    <td>0.30</td>
                    <td>0.12</td>
                    <td>49</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/c850a77b117340d998ba6f02bb5442f8?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [151] glrmlikeabee</p>
                    </td>
                    <td>151</td>
                    <td>2.34</td>
                    <td>3158</td>
                    <td style="padding-right: 30px; padding-left: 30px;">827</td>
                    <td>1.26</td>
                    <td>0.68</td>
                    <td>56</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/79749a2464614fe6ae3cf539f83e96ec?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [11] matrixsorcecode</p>
                    </td>
                    <td>11</td>
                    <td>0.32</td>
                    <td>59</td>
                    <td style="padding-right: 30px; padding-left: 30px;">1</td>
                    <td>0.16</td>
                    <td>0.13</td>
                    <td>12</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/52cf2df80af645169b66d7944f6bc04f?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [18] Danielvijay</p>
                    </td>
                    <td>18</td>
                    <td>0.12</td>
                    <td>38</td>
                    <td style="padding-right: 30px; padding-left: 30px;">0</td>
                    <td>0.01</td>
                    <td>0.07</td>
                    <td>8</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/dce3c359c6cb49549db26016f1e3c7cc?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [5] QC_R41n60w</p>
                    </td>
                    <td>5</td>
                    <td>0.18</td>
                    <td>17</td>
                    <td style="padding-right: 30px; padding-left: 30px;">0</td>
                    <td>0.05</td>
                    <td>NaN</td>
                    <td>12</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/fb7e5e0bcc2b4115a7f6b445aa29ce53?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [15] Natacrack</p>
                    </td>
                    <td>15</td>
                    <td>0.26</td>
                    <td>70</td>
                    <td style="padding-right: 30px; padding-left: 30px;">1</td>
                    <td>0.11</td>
                    <td>0.13</td>
                    <td>6</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/c0921f023e0e4e689f8a61c9c176f4fe?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [51] red_panda987</p>
                    </td>
                    <td>51</td>
                    <td>0.19</td>
                    <td>157</td>
                    <td style="padding-right: 30px; padding-left: 30px;">2</td>
                    <td>0.10</td>
                    <td>0.11</td>
                    <td>49</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/5e07e69998584516923f0067b31f7cb8?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [98] TrashAtBuilding</p>
                    </td>
                    <td>98</td>
                    <td>0.69</td>
                    <td>1417</td>
                    <td style="padding-right: 30px; padding-left: 30px;">47</td>
                    <td>0.46</td>
                    <td>0.22</td>
                    <td>48</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/f67ef53bfc5449698a19f640db0f4126?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [350] lowof</p>
                    </td>
                    <td>350</td>
                    <td>7.92</td>
                    <td>12566</td>
                    <td style="padding-right: 30px; padding-left: 30px;">21954</td>
                    <td>2.84</td>
                    <td>2.59</td>
                    <td>51</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/adb80b5c4d9c4fb0a578cd3090df3d47?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [306] PUG87YONI</p>
                    </td>
                    <td>306</td>
                    <td>0.42</td>
                    <td>2352</td>
                    <td style="padding-right: 30px; padding-left: 30px;">54</td>
                    <td>0.30</td>
                    <td>0.10</td>
                    <td>21</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/d89e094b32614f2f8d4ddfb930ccadae?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [176] MistyCreeper</p>
                    </td>
                    <td>176</td>
                    <td>1.41</td>
                    <td>2982</td>
                    <td style="padding-right: 30px; padding-left: 30px;">350</td>
                    <td>0.87</td>
                    <td>0.60</td>
                    <td>59</td>
                </tr>
                <tr style="padding-bottom: 5px;">
                    <td style="padding-right: 40px; display: flex;"><img
                            src="https://crafatar.com/avatars/3f1e98cc5c7c4c47a130e9fddee6263c?size=15&amp;default=MHF_Steve&amp;overlay"
                            style="padding-right: 10px;">
                        <p> [26] XSkillX</p>
                    </td>
                    <td>26</td>
                    <td>0.95</td>
                    <td>279</td>
                    <td style="padding-right: 30px; padding-left: 30px;">23</td>
                    <td>0.58</td>
                    <td>0.22</td>
                    <td>39</td>
                </tr>
            </tbody>
        </table>

    </div>
    <script>
        function show() {
            document.getElementById("sidebar").classList.toggle('active');
        }
    </script>
    <script>
        function to_gui(arr) {

        }
    </script>
    <script>
        console.log("running")
        const electron = require('electron');
        const readLastLines = require('read-last-lines');
        var fs = require('fs');
        const path = require('path');
        var options = {
            logFile: '../../../../../../Users/simon/.lunarclient/offline/1.8/logs/latest.log',
            endOfLineChar: require('os').EOL
        };
        // Obtain the initial size of the log file before we begin watching it.
        var fileSize = fs.statSync(options.logFile).size;
        fs.watchFile(options.logFile, function (current, previous) {
            // Check if file modified time is less than last time.
            // If so, nothing changed so don't bother parsing.
            if (current.mtime <= previous.mtime) {
                return;
            }

            // We're only going to read the portion of the file that
            // we have not read so far. Obtain new file size.
            var newFileSize = fs.statSync(options.logFile).size;
            // Calculate size difference.
            var sizeDiff = newFileSize - fileSize;
            // If less than zero then Hearthstone truncated its log file
            // since we last read it in order to save space.
            // Set fileSize to zero and set the size difference to the current
            // size of the file.
            if (sizeDiff < 0) {
                fileSize = 0;
                sizeDiff = newFileSize;
            }
            // Create a buffer to hold only the data we intend to read.
            var buffer = new Buffer(sizeDiff);
            // Obtain reference to the file's descriptor.
            var fileDescriptor = fs.openSync(options.logFile, 'r');
            // Synchronously read from the file starting from where we read
            // to last time and store data in our buffer.
            fs.readSync(fileDescriptor, buffer, 0, sizeDiff, fileSize);
            fs.closeSync(fileDescriptor); // close the file
            // Set old file size to the new size for next read.
            fileSize = newFileSize;

            // Parse the line(s) in the buffer.
            parseBuffer(buffer);
        });

        function stop() {
            fs.unwatchFile(options.logFile);
        };
        var stats = [];

        function parseBuffer(buffer) {
            // Iterate over each line in the buffer.
            buffer.toString().split(options.endOfLineChar).forEach(function (line) {
                // Do stuff with the line :)
                console.log('change')
                line_parts = line.split(' ')
                if (line_parts[4] == "ONLINE:") {
                    stats = []
                    names = line_parts.slice(5);
                    //console.log(names)
                    const table_body = document.querySelector('tbody');
                    //console.log("poo");
                    table_body.innerHTML = "";
                    for (ind in names) {
                        let name = names[ind].replace(",", "");
                        getData(name);
                        //console.log(arr)
                        //stats.push(arr)
                    }
                    //console.log(stats)

                    //FINALLYt
                }
            });
        }

        function getData(name) {
            console.log(name)
            let uid = ''
            fetch('https://api.mojang.com/users/profiles/minecraft/' + name + '?at=')
                .then(result => {
                    return result.json()
                })

                .then(({
                    id
                }) => {
                    //console.log(id)
                    // Log the player's username
                    uid = id;
                    fetch("https://api.hypixel.net/player?key=3aadacc6-2c7d-485e-8b8d-801109c40c46&uuid=" +
                            uid)
                        .then(result => result.json())
                        .then(({
                            player
                        }) => {
                            stats = []
                            //console.log(player)
                            // Log the player's username
                            let name = player.displayname
                            let last_login = player.lastLogin
                            let star = player.achievements.bedwars_level
                            let ws = player.stats.Bedwars.winstreak
                            let finals = player.stats.Bedwars.final_kills_bedwars
                            let final_deaths = player.stats.Bedwars.final_deaths_bedwars
                            let fkdr;
                            if (!final_deaths) {
                                fkdr = finals
                            } else {
                                fkdr = (finals / final_deaths).toFixed(2)
                            }
                            let beds = player.stats.Bedwars.beds_broken_bedwars
                            let beds_lost = player.stats.Bedwars.beds_lost_bedwars
                            let bbl;
                            if (!beds_lost) {
                                bbl = beds
                            } else {
                                bbl = (beds / beds_lost).toFixed(2)
                            }
                            let wins = player.stats.Bedwars.wins_bedwars
                            let losses = player.stats.Bedwars.losses_bedwars
                            let wlr;
                            if (!losses) {
                                wlr = wins
                            } else {
                                wlr = (wins / losses).toFixed(2)
                            }
                            let index = ((fkdr ** 2) * star).toFixed(0)
                            name = "https://crafatar.com/avatars/" + uid +
                                "?size=15&default=MHF_Steve&overlay" + " [" + star.toString() + "]" + " " +
                                name;
                            time = new Date(Date.now());
                            console.log(time)
                            var login = new Date(last_login);
                            console.log(login)
                            const diffInMins = Math.floor(Math.abs(time - login) / 60) % 60;
                            console.log(diffInMins)
                            stats.push(name, star, fkdr, finals, index, bbl, wlr,
                                diffInMins
                            )
                            const table_body = document.querySelector('tbody');
                            const tr = document.createElement("tr");
                            tr.style.paddingBottom = "5px"
                            for (i in stats) {
                                //console.log(i)
                                //console.log(stats[i])
                                const data = document.createElement("td");

                                if (i == 0) {
                                    const im = document.createElement("img")
                                    const par = document.createElement("p")
                                    parts = stats[i].split(" ")
                                    im.src = parts[0]
                                    im.style.paddingRight = "0px";
                                    data.appendChild(im)
                                    par.innerHTML = "  " + parts[1] + " " + parts[2];
                                    data.style.paddingRight = "40px"
                                    data.appendChild(par)
                                    data.style.display = "flex";
                                } else if (i == 4) {
                                    data.style.paddingRight = "30px"
                                    data.style.paddingLeft = "30px"
                                } else if (i == 8) {
                                    data.style.paddingRight = "0px"
                                }
                                if (i != 0) {
                                    data.innerHTML = stats[i]
                                }
                                tr.appendChild(data)
                            }

                            table_body.appendChild(tr)



                        });
                })
                .catch((error) => {
                    //console.log('err')
                    stats.push(name, 'NICKED', 'NICKED', 'NICKED', 'NICKED', "NICKED",
                        'NICKED', 'NICKED', 'NICKED'
                    )
                })
                .finally(() => {
                    //console.log(stats)
                    return stats
                });





        }
    </script>





</body>

</html>